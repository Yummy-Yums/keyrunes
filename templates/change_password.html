{% extends "base.html" %}

{% block content %}
  <section class="card">
    <h2>Change Password Required</h2>
    
    <div class="alert alert-warning">
      <strong>First Login Detected!</strong><br>
      For security reasons, you must change your password before continuing.
    </div>

    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <form method="post" action="/change-password" autocomplete="off" id="changePasswordForm">
      <label for="current_password">Current Password</label>
      <input id="current_password" name="current_password" type="password" required />

      <label for="new_password">New Password</label>
      <input id="new_password" name="new_password" type="password" required minlength="8" />
      <small>Password must be at least 8 characters long</small>

      <label for="confirm_password">Confirm New Password</label>
      <input id="confirm_password" name="confirm_password" type="password" required minlength="8" />

      <button type="submit">Change Password</button>
    </form>

    <script>
      document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const currentPassword = document.getElementById('current_password').value;
        const newPassword = document.getElementById('new_password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        
        if (newPassword !== confirmPassword) {
          alert('New passwords do not match');
          return;
        }
        
        try {
          const response = await fetch('/api/change-password', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + localStorage.getItem('jwt_token')
            },
            body: JSON.stringify({
              current_password: currentPassword,
              new_password: newPassword
            })
          });
          
          if (response.ok) {
            alert('Password changed successfully!');
            window.location.href = '/dashboard';
          } else {
            const error = await response.text();
            document.querySelector('.alert-danger') ? 
              document.querySelector('.alert-danger').textContent = error :
              document.querySelector('form').insertAdjacentHTML('beforebegin', 
                `<div class="alert alert-danger">${error}</div>`);
          }
        } catch (error) {
          alert('Network error: ' + error.message);
        }
      });
    </script>
  </section>
{% endblock %}
