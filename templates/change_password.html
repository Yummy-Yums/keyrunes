{% extends "base.html" %}

{% block content %}
<section class="card">
  <h2>Change Password</h2>
  
  <div class="alert alert-warning">
    <strong>First Login Detected!</strong><br>
    For security reasons, you must change your password before continuing.
  </div>

  <div id="change-password-messages"></div>

  <form hx-post="/change-password"
        hx-target="#change-password-messages"
        hx-swap="innerHTML"
        hx-indicator="#change-password-indicator"
        hx-on::after-request="handlePasswordChange(event)">
    <label for="current_password">Current Password</label>
    <input id="current_password" name="current_password" type="password" required />

    <label for="new_password">New Password</label>
    <input id="new_password" name="new_password" type="password" required minlength="8" />
    <small>Password must be at least 8 characters long</small>

    <label for="confirm_password">Confirm New Password</label>
    <input id="confirm_password" name="confirm_password" type="password" required minlength="8" />

    <button type="submit">
      <span class="htmx-indicator" id="change-password-indicator">Changing password...</span>
      Change Password
    </button>
  </form>
</section>

<script>
function handlePasswordChange(event) {
  if (event.detail.successful) {
    // Check if response is a redirect
    const response = event.detail.xhr.responseText;
    if (response.includes('dashboard') || event.detail.xhr.status === 200) {
      window.location.href = '/dashboard';
    }
  } else {
    // Error will be shown in the messages div
    const messagesDiv = document.getElementById('change-password-messages');
    if (!messagesDiv.innerHTML) {
      messagesDiv.innerHTML = '<div class="message message-error">Error changing password. Please try again.</div>';
    }
  }
}

// Client-side validation
document.querySelector('form').addEventListener('submit', function(e) {
  const newPassword = document.getElementById('new_password').value;
  const confirmPassword = document.getElementById('confirm_password').value;
  
  if (newPassword !== confirmPassword) {
    e.preventDefault();
    document.getElementById('change-password-messages').innerHTML = 
      '<div class="message message-error">New passwords do not match</div>';
    return false;
  }
  
  if (newPassword.length < 8) {
    e.preventDefault();
    document.getElementById('change-password-messages').innerHTML = 
      '<div class="message message-error">Password must be at least 8 characters long</div>';
    return false;
  }
});
</script>
{% endblock %}
