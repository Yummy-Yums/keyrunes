{% extends "base.html" %}

{% block header %}
<h1>Keyrunes</h1>
<hr />
{% endblock header %}

{% block content %}
<section class="card">
  <h2>Dashboard</h2>

  <div id="user-info" hx-get="/api/me" hx-trigger="load" hx-swap="innerHTML">
    <p>Loading user information...</p>
  </div>
</section>

<section class="card" id="org-settings" style="display: none; margin-top: 1rem;">
  <h2>Organization Settings</h2>
  <div id="org-secret-content">
    <p class="htmx-indicator">Loading organization secret...</p>
  </div>
  <div style="margin-top: 1rem;">
    <a href="/admin" id="admin-panel-link" style="display: none;" class="btn btn-secondary">Open System Admin Panel</a>
  </div>
</section>

<section class="card" id="org-list-section" style="display: none; margin-top: 1rem;">
  <h2>Your Organizations</h2>
  <div id="org-list-content">Loading...</div>
</section>

<section class="card" id="superadmin-section" style="display: none; margin-top: 1rem;">
  <h2>System Administration</h2>
  <h3>Create New Organization</h3>
  <div id="create-org-message"></div>
  <form hx-post="/api/admin/organizations" hx-target="#create-org-message" hx-swap="innerHTML"
    hx-indicator="#create-org-indicator" hx-on::after-request="handleOrgCreation(event)" hx-ext="json-enc">
    <label>Organization Name:</label>
    <input type="text" name="name" id="org-name" required oninput="generateNamespace(this.value)">

    <label>Namespace (Schema Name):</label>
    <input type="text" name="namespace" id="org-namespace" required pattern="[a-zA-Z0-9_]+"
      title="Alphanumeric and underscores only">
    <small>Used for database schema isolation. Must be unique.</small>

    <label>Base URL (Optional):</label>
    <input type="url" name="base_url" id="org-base-url" placeholder="https://tenant.example.com">

    <label>Description:</label>
    <textarea name="description" id="org-description" rows="3"></textarea>

    <button type="submit" class="btn btn-primary">
      <span class="htmx-indicator" id="create-org-indicator">Creating...</span>
      Create Organization
    </button>
  </form>
</section>

<script>
  function logout() {
    document.cookie = 'jwt_token=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 UTC;';
    window.location.href = '/login';
  }

  function handleOrgCreation(event) {
    console.log('üéØ handleOrgCreation called:', event.detail);
    const messageDiv = document.getElementById('create-org-message');
    if (event.detail.successful) {
      try {
        const org = JSON.parse(event.detail.xhr.responseText);
        console.log('‚úÖ Organization created:', org);
        messageDiv.innerHTML = `<div class="message message-success">Organization <strong>${org.name}</strong> created successfully! (ID: ${org.organization_id})</div>`;
        event.detail.elt.reset();
      } catch (e) {
        console.error('‚ùå Parse error:', e);
        messageDiv.innerHTML = `<div class="message message-success">Organization created successfully!</div>`;
      }
    } else {
      console.error('‚ùå Request failed:', event.detail.xhr.status, event.detail.xhr.responseText);
      messageDiv.innerHTML = `<div class="message message-error">Error: ${event.detail.xhr.responseText}</div>`;
    }
  }

  document.body.addEventListener('htmx:afterSwap', function (evt) {
    if (evt.detail.target.id === 'user-info') {
      try {
        const user = JSON.parse(evt.detail.xhr.responseText);
        evt.detail.target.innerHTML = `
        <div class="message message-success">
          Welcome, <strong>${user.username}</strong>! (${user.email})<br>
          <small>Organization ID: ${user.organization_id} | Namespace: <strong>${user.namespace}</strong></small>
        </div>
        
        <h3>Your Groups</h3>
        <ul>
          ${user.groups && user.groups.length > 0
            ? user.groups.map(g => `<li>${g}</li>`).join('')
            : '<li>No groups assigned</li>'}
        </ul>
        
        <div style="margin-top: 2rem;">
          <button onclick="logout()" class="btn btn-secondary">Logout</button>
          <a href="/profile" class="btn btn-primary">Edit Profile</a>
          ${user.first_login ? '<a href="/change-password" class="btn btn-warning">Change Password</a>' : ''}
        </div>
      `;

        if (user.first_login) {
          if (confirm('You need to change your password. Would you like to do it now?')) {
            window.location.href = '/change-password';
          }
        }

        const isSuperadmin = user.groups && user.groups.includes('superadmin');
        const isAdmin = user.groups && (user.groups.includes('admin') || isSuperadmin);

        if (isSuperadmin && user.namespace === 'public') {
          const saSection = document.getElementById('superadmin-section');
          if (saSection) saSection.style.display = 'block';

          const adminLink = document.getElementById('admin-panel-link');
          if (adminLink) adminLink.style.display = 'inline-block';
        } else if (isAdmin) {
          const adminLink = document.getElementById('admin-panel-link');
          if (adminLink) adminLink.style.display = 'inline-block';
        }

        if (isAdmin) {
          const orgSection = document.getElementById('org-settings');
          if (orgSection) {
            orgSection.style.display = 'block';
            fetch('/api/org/secret', {
              credentials: 'include'
            })
              .then(r => {
                if (!r.ok) {
                  document.getElementById('org-secret-content').innerHTML = `<p class="message message-error">Error loading secret.</p>`;
                  return null;
                }
                return r.json();
              })
              .then(data => {
                if (!data) return;
                document.getElementById('org-secret-content').innerHTML = `
                <div class="card" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                  <p><strong>App ID:</strong> <code>${data.organization_id}</code></p>
                  <p><strong>App Secret:</strong> <code id="org-secret-key">${data.secret_key}</code></p>
                  <button onclick="rotateOrgKey()" class="btn btn-warning btn-sm">Rotate Secret</button>
                </div>
              `;
              })
              .catch(err => {
                document.getElementById('org-secret-content').innerHTML = `<p class="message message-error">Error loading secret.</p>`;
              });

            const orgListSection = document.getElementById('org-list-section');
            if (orgListSection) {
              orgListSection.style.display = 'block';
              fetch('/api/admin/organizations', { credentials: 'include' })
                .then(r => r.json())
                .then(orgs => {
                  if (Array.isArray(orgs)) {
                    const listHtml = orgs.map(org => {
                      const deleteBtn = (user.namespace === 'public')
                        ? `<button class="btn btn-sm btn-danger" onclick="deleteOrganization(${org.organization_id}, '${org.name}')" style="background: #dc3545; color: white; border: none; padding: 0.2rem 0.5rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem;">Delete</button>`
                        : '';

                      return `
                      <div style="border-bottom: 1px solid #eee; padding: 0.5rem 0; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                          <strong>${org.name}</strong> (ID: ${org.organization_id})
                          <br><small>${org.description || 'No description'}</small>
                        </div>
                        <div>
                          <a href="/admin?org_id=${org.organization_id}" class="btn btn-sm btn-secondary">Manage</a>
                          ${deleteBtn}
                        </div>
                      </div>
                    `}).join('');
                    document.getElementById('org-list-content').innerHTML = listHtml || 'No organizations found.';
                  } else {
                    document.getElementById('org-list-content').innerHTML = '<p>No organizations found.</p>';
                  }
                })
                .catch(e => {
                  console.error("Failed to load orgs", e);
                  document.getElementById('org-list-content').innerHTML = '<p class="message message-error">Failed to load organizations.</p>';
                });
            }
          }
        }
      } catch (e) {
        evt.detail.target.innerHTML = `
        <div class="message message-error">
          Error loading user information. Please <a href="/login">login</a> again.
        </div>
      `;
      }
    }
  });

  function generateNamespace(name) {
    const namespaceInput = document.getElementById('org-namespace');
    if (namespaceInput) {
      const slug = name.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_');
      namespaceInput.value = slug;
    }
  }

  function deleteOrganization(orgId, orgName) {
    if (!confirm(`Are you sure you want to delete organization "${orgName}"? This action cannot be undone.`)) return;

    fetch(`/api/admin/organizations/${orgId}`, {
      method: 'DELETE',
      credentials: 'include'
    })
      .then(r => {
        if (r.ok) {
          alert(`Organization "${orgName}" deleted successfully.`);
          window.location.reload();
        } else {
          r.text().then(msg => alert('Error deleting organization: ' + msg));
        }
      })
      .catch(err => alert('Error deleting organization: ' + err.message));
  }

  function rotateOrgKey() {
    if (!confirm('Are you sure you want to rotate the organization secret? The old key will stop working immediately.')) return;

    fetch('/api/org/secret/rotate', {
      method: 'POST',
      credentials: 'include'
    })
      .then(r => r.json())
      .then(data => {
        const keyEl = document.getElementById('org-secret-key');
        if (keyEl) {
          keyEl.textContent = data.secret_key;
          keyEl.style.backgroundColor = '#d4edda';
          setTimeout(() => { keyEl.style.backgroundColor = ''; }, 2000);
        }
      })
      .catch(err => alert('Error rotating key: ' + err.message));
  }
</script>
{% endblock %}