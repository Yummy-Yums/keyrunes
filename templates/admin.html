{% extends "base.html" %}

{% block header %}
<h1>Keyrunes Admin Panel</h1>
<p>Logged in as: <strong>{{ user.username }}</strong> ({{ user.email }}) | <a href="/dashboard">← Back to Dashboard</a>
</p>
<hr />
{% endblock header %}

{% block content %}
<section class="card">
  <div id="messages"></div>

  <div class="tabs">
    <button class="tab-btn active" onclick="showTab('users')">Users</button>
    <button class="tab-btn" onclick="showTab('groups')">Groups</button>
    <button class="tab-btn" onclick="showTab('organizations')">Organizations</button>
    <button class="tab-btn" onclick="showTab('permissions')">Permissions</button>
  </div>

  <!-- Users Tab -->
  <div id="users-tab" class="tab-content active">
    <div style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0;">
      <h3>Users Management</h3>
      <button onclick="showCreateUserModal()">Create User</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Username</th>
          <th>Email</th>
          <th>Groups</th>
          <th>Created At</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="users-list" hx-indicator="#users-loading">
        <tr id="users-loading">
          <td colspan="6" style="text-align: center;">
            <span class="htmx-indicator">Loading users...</span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Groups Tab -->
  <div id="groups-tab" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0;">
      <h3>Groups Management</h3>
      <button onclick="showCreateGroupModal()">Create Group</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Description</th>
          <th>Created At</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="groups-list" hx-indicator="#groups-loading">
        <tr id="groups-loading">
          <td colspan="5" style="text-align: center;">
            <span class="htmx-indicator">Loading groups...</span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Organizations Tab -->
  <div id="organizations-tab" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0;">
      <h3>Organizations</h3>
      {% if user.namespace == "public" %}
      <button onclick="showCreateOrganizationModal()">Create Organization</button>
      {% endif %}
    </div>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Description</th>
          <th>Secret Key</th>
          <th>Created At</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="organizations-list" hx-indicator="#organizations-loading">
        <tr id="organizations-loading">
          <td colspan="6" style="text-align: center;">
            <span class="htmx-indicator">Loading organizations...</span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Permissions Tab -->
  <div id="permissions-tab" class="tab-content">
    <h3>Permission Check</h3>
    <div class="card" style="background: var(--card-bg, #f8f9fa); margin-top: 1rem;">
      <h4>Check User Permission</h4>
      <form hx-post="/api/admin/check-permission" hx-target="#permission-result" hx-swap="innerHTML"
        hx-indicator="#check-permission-indicator" hx-ext="json-enc">
        <label>User ID:</label>
        <input type="number" name="user_id" required>

        <label>Group Name:</label>
        <input type="text" name="group_name" required>

        <label>Resource:</label>
        <input type="text" name="resource" placeholder="e.g., user:*, admin:*" required>

        <label>Action:</label>
        <input type="text" name="action" placeholder="e.g., read, write, delete" required>

        <button type="submit">
          <span class="htmx-indicator" id="check-permission-indicator">Checking...</span>
          Check Permission
        </button>
      </form>
      <div id="permission-result"></div>
    </div>
  </div>
</section>

<!-- Modal: Create User -->
<div id="createUserModal" class="modal">
  <div class="modal-content card">
    <button class="modal-close" onclick="closeModal('createUserModal')">&times;</button>
    <h3>Create New User</h3>
    <form hx-post="/api/admin/user" hx-target="#messages" hx-swap="innerHTML" hx-indicator="#create-user-indicator"
      hx-on::after-request="handleUserCreated(event)" hx-ext="json-enc">
      <label>Email:</label>
      <input type="hidden" name="organization_id" value="1">
      <input type="email" name="email" id="user-email" required>

      <label>Username:</label>
      <input type="text" name="username" id="user-username" required>

      <label>Password:</label>
      <input type="text" name="password" id="user-password" required minlength="8" placeholder="Min. 8 characters">

      <label>
        <input type="checkbox" name="first_login" id="user-first-login" value="true">
        Require password change on first login
      </label>

      <button type="submit">
        <span class="htmx-indicator" id="create-user-indicator">Creating...</span>
        Create User
      </button>
    </form>
  </div>
</div>

</div>

<!-- Modal: Edit User -->
<div id="editUserModal" class="modal">
  <div class="modal-content card">
    <button class="modal-close" onclick="closeModal('editUserModal')">&times;</button>
    <h3>Edit User</h3>
    <form hx-patch="/api/admin/users/0" hx-target="#messages" hx-swap="innerHTML" hx-indicator="#edit-user-indicator"
      hx-on::after-request="handleUserUpdated(event)" hx-ext="json-enc" id="edit-user-form">
      <input type="hidden" name="user_id" id="edit-user-id">

      <label>Email:</label>
      <input type="email" name="email" id="edit-user-email" required>

      <label>Username:</label>
      <input type="text" name="username" id="edit-user-username" required>

      <label>
        <input type="checkbox" name="first_login" id="edit-user-first-login">
        Require password change
      </label>

      <button type="submit">
        <span class="htmx-indicator" id="edit-user-indicator">Updating...</span>
        Update User
      </button>
    </form>
  </div>
</div>

<!-- Modal: Create Group -->
<div id="createGroupModal" class="modal">
  <div class="modal-content card">
    <button class="modal-close" onclick="closeModal('createGroupModal')">&times;</button>
    <h3>Create New Group</h3>
    <form hx-post="/api/admin/groups" hx-target="#messages" hx-swap="innerHTML" hx-indicator="#create-group-indicator"
      hx-on::after-request="handleGroupCreated(event)" hx-ext="json-enc">
      <label>Group Name:</label>
      <input type="hidden" name="organization_id" value="1">
      <input type="text" name="name" id="group-name" required>

      <label>Description:</label>
      <textarea name="description" id="group-description" rows="3"></textarea>

      <button type="submit">
        <span class="htmx-indicator" id="create-group-indicator">Creating...</span>
        Create Group
      </button>
    </form>
  </div>
</div>

<!-- Modal: Assign Group -->
<div id="assignGroupModal" class="modal">
  <div class="modal-content card">
    <button class="modal-close" onclick="closeModal('assignGroupModal')">&times;</button>
    <h3>Assign User to Group</h3>
    <div id="assign-group-form-container">
      <p>Loading groups...</p>
    </div>
  </div>
</div>

<!-- Modal: Create Organization -->
<div id="createOrganizationModal" class="modal">
  <div class="modal-content card">
    <button class="modal-close" onclick="closeModal('createOrganizationModal')">&times;</button>
    <h3>Create New Organization</h3>
    <form hx-post="/api/admin/organizations" hx-target="#messages" hx-swap="innerHTML"
      hx-indicator="#create-org-indicator" hx-on::after-request="handleOrganizationCreated(event)" hx-ext="json-enc">
      <label>Organization Name:</label>
      <input type="text" name="name" id="org-name" required>

      <label>Description:</label>
      <textarea name="description" id="org-description" rows="3"></textarea>

      <button type="submit">
        <span class="htmx-indicator" id="create-org-indicator">Creating...</span>
        Create Organization
      </button>
    </form>
  </div>
</div>

<script>
  function getOrgId() {
    const params = new URLSearchParams(window.location.search);
    return params.get('org_id') || {{ user.organization_id }};
  }

  document.addEventListener('DOMContentLoaded', () => {
    const orgId = getOrgId();
    document.querySelectorAll('input[name="organization_id"]').forEach(input => {
      input.value = orgId;
    });

    if (orgId != 1) {
      const header = document.querySelector('h1');
      header.innerText += ` (Organization ID: ${orgId})`;
    }
  });


  function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

    document.getElementById(tabName + '-tab').classList.add('active');
    event.target.classList.add('active');

    if (tabName === 'users') {
      loadUsers();
    } else if (tabName === 'groups') {
      loadGroups();
    } else if (tabName === 'organizations') {
      loadOrganizations();
    }
  }

  function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
  }

  function showModal(modalId) {
    document.getElementById(modalId).classList.add('active');
  }

  function showCreateUserModal() {
    showModal('createUserModal');
  }

  function showEditUserModal(userId, email, username, firstLogin) {
    document.getElementById('edit-user-id').value = userId;
    document.getElementById('edit-user-email').value = email;
    document.getElementById('edit-user-username').value = username;
    document.getElementById('edit-user-first-login').checked = firstLogin;

    const form = document.getElementById('edit-user-form');
    form.setAttribute('hx-patch', `/api/admin/users/${userId}?org_id=${getOrgId()}`);
    htmx.process(form);

    showModal('editUserModal');
  }

  function handleUserUpdated(event) {
    if (event.detail.successful) {
      closeModal('editUserModal');
      loadUsers();
      showMessage('User updated successfully!', 'success');
    } else {
      const errorText = event.detail.xhr?.responseText || 'Unknown error';
      showMessage('Error updating user: ' + errorText, 'error');
    }
  }

  function resetUserPassword(userId) {
    if (!confirm(`Are you sure you want to reset the password for user ID ${userId}?\nA temporary password will be generated.`)) return;

    fetch(`/api/admin/users/${userId}/reset-password?org_id=${getOrgId()}`, {
      method: 'POST',
      credentials: 'include'
    })
      .then(r => r.json())
      .then(data => {
        if (data.temporary_password) {
          alert(`Success! Temporary Password: ${data.temporary_password}\n(Copy this now, it won't be shown again)`);
        } else {
          showMessage('Error resetting password: ' + (data.error || 'Unknown error'), 'error');
        }
      })
      .catch(err => showMessage('Error resetting password: ' + err.message, 'error'));
  }

  function sendResetEmail(userId) {
    if (!confirm(`Send password reset email to user ID ${userId}?`)) return;

    fetch(`/api/admin/users/${userId}/send-reset?org_id=${getOrgId()}`, {
      method: 'POST',
      credentials: 'include'
    })
      .then(r => {
        if (r.ok) {
          showMessage('Reset email sent successfully!', 'success');
        } else {
          r.text().then(msg => showMessage('Error sending email: ' + msg, 'error'));
        }
      })
      .catch(err => showMessage('Error sending email: ' + err.message, 'error'));
  }

  function showCreateGroupModal() {
    showModal('createGroupModal');
  }

  function showCreateOrganizationModal() {
    showModal('createOrganizationModal');
  }

  function updateAssignFormAction(select, userId) {
    const form = select.closest('form');
    form.setAttribute('hx-post', `/api/admin/users/${userId}/groups/${select.value}?org_id=${getOrgId()}`);
    htmx.process(form); // Re-process to pick up the new hx-post
  }

  function removeUserFromGroup(userId, groupName) {
    if (!confirm(`Remove user ${userId} from group ${groupName}?`)) {
      return;
    }

    fetch(`/api/admin/groups?org_id=${getOrgId()}`, {
      credentials: 'include'
    })
      .then(r => r.json())
      .then(groups => {
        const group = groups.find(g => g.name === groupName);
        if (!group) {
          showMessage('Group not found', 'error');
          return;
        }

        fetch(`/api/admin/users/${userId}/groups/${group.group_id}?org_id=${getOrgId()}`, {
          method: 'DELETE',
          credentials: 'include'
        })
          .then(r => {
            if (r.ok) {
              loadUsers();
              showMessage('User removed from group successfully!', 'success');
            } else {
              return r.text().then(text => {
                showMessage('Error removing user from group: ' + text, 'error');
              });
            }
          })
          .catch(err => {
            showMessage('Error removing user from group: ' + err.message, 'error');
          });
      })
      .catch(err => {
        showMessage('Error loading groups: ' + err.message, 'error');
      });
  }

  function showAssignGroupModal(userId) {
    const modal = document.getElementById('assignGroupModal');
    const container = document.getElementById('assign-group-form-container');

    fetch(`/api/admin/groups?org_id=${getOrgId()}`, {
      credentials: 'include'
    })
      .then(r => r.json())
      .then(groups => {
        container.innerHTML = `
      <form hx-post="/api/admin/users/${userId}/groups/0"
            hx-target="#messages"
            hx-swap="innerHTML"
            hx-indicator="#assign-group-indicator"
            hx-on::after-request="handleGroupAssigned(event)"
            hx-ext="json-enc">
        <label>Select Group:</label>
        <select name="group_id" id="assign-group-select" required onchange="updateAssignFormAction(this, ${userId})">
          <option value="">Select a group...</option>
          ${groups.map(g => `<option value="${g.group_id}">${g.name}</option>`).join('')}
        </select>
        <button type="submit">
          <span class="htmx-indicator" id="assign-group-indicator">Assigning...</span>
          Assign
        </button>
      </form>
    `;
        showModal('assignGroupModal');
      })
      .catch(err => {
        container.innerHTML = `<p class="message message-error">Error loading groups: ${err.message}</p>`;
      });
  }

  function handleUserCreated(event) {
    if (event.detail.successful) {
      closeModal('createUserModal');
      loadUsers();
      showMessage('User created successfully!', 'success');
      document.querySelector('#createUserModal form').reset();
    } else {
      const errorText = event.detail.xhr?.responseText || 'Unknown error';
      showMessage('Error creating user: ' + errorText, 'error');
    }
  }

  function handleGroupCreated(event) {
    if (event.detail.successful) {
      closeModal('createGroupModal');
      loadGroups();
      showMessage('Group created successfully!', 'success');
      document.querySelector('#createGroupModal form').reset();
    } else {
      const errorText = event.detail.xhr?.responseText || 'Unknown error';
      showMessage('Error creating group: ' + errorText, 'error');
    }
  }

  function handleOrganizationCreated(event) {
    if (event.detail.successful) {
      closeModal('createOrganizationModal');
      loadOrganizations();
      showMessage('Organization created successfully!', 'success');
      document.querySelector('#createOrganizationModal form').reset();
    } else {
      const errorText = event.detail.xhr?.responseText || 'Unknown error';
      showMessage('Error creating organization: ' + errorText, 'error');
    }
  }

  function handleGroupAssigned(event) {
    if (event.detail.successful) {
      closeModal('assignGroupModal');
      loadUsers();
      showMessage('User assigned to group successfully!', 'success');
    } else {
      const errorText = event.detail.xhr?.responseText || 'Unknown error';
      showMessage('Error assigning user to group: ' + errorText, 'error');
    }
  }

  function showMessage(text, type) {
    const messagesDiv = document.getElementById('messages');
    const messageClass = type === 'success' ? 'message-success' : 'message-error';
    messagesDiv.innerHTML = `<div class="message ${messageClass}">${text}</div>`;
    setTimeout(() => {
      messagesDiv.innerHTML = '';
    }, 5000);
  }

  function loadUsers() {
    const tbody = document.getElementById('users-list');
    fetch(`/api/admin/users?org_id=${getOrgId()}`, {
      credentials: 'include'
    })
      .then(r => r.json())
      .then(users => {
        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No users found</td></tr>';
        } else {
          tbody.innerHTML = users.map(user => {
            const groups = user.groups || [];
            const groupsDisplay = groups.length > 0
              ? groups.map(group => {
                // Escape group name for JavaScript string
                const escapedGroup = String(group).replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');
                return `
              <span style="display: inline-block; margin: 2px; padding: 4px 8px; background: var(--card-bg, #f0f0f0); border-radius: 4px;">
                ${group}
                <button onclick="removeUserFromGroup(${user.user_id}, '${escapedGroup}')" 
                        style="margin-left: 4px; padding: 2px 6px; font-size: 0.8em; background: var(--error-bg, #f8d7da); border: none; border-radius: 3px; cursor: pointer;"
                        title="Remove from ${group}">×</button>
              </span>
            `;
              }).join('')
              : 'None';

            return `
        <tr>
          <td>${user.user_id}</td>
          <td>${user.username}</td>
          <td>${user.email}</td>
          <td>${groupsDisplay}</td>
          <td>${new Date(user.created_at).toLocaleDateString()}</td>
          <td>
            <button onclick="showAssignGroupModal(${user.user_id})" class="btn-sm">Assign Group</button>
            <button onclick="showEditUserModal(${user.user_id}, '${user.email}', '${user.username}', ${user.first_login})" class="btn-sm btn-primary" style="background: var(--primary, #007bff); color: white;">Edit</button>
            <button onclick="deleteUser(${user.user_id}, '${user.username}')" class="btn-sm btn-danger" style="background-color: var(--error-bg, #f8d7da); color: var(--error-color, #721c24);">Delete</button>
            <div style="margin-top: 4px;">
                <button onclick="resetUserPassword(${user.user_id})" class="btn-sm btn-warning" style="background: var(--warning, #ffc107); color: black;">Reset PWD</button>
                <button onclick="sendResetEmail(${user.user_id})" class="btn-sm btn-info" style="background: var(--info, #17a2b8); color: white;">Send Email</button>
            </div>
          </td>
        </tr>
      `;
          }).join('');
        }
      })
      .catch(err => {
        tbody.innerHTML = `<tr><td colspan="6" class="message message-error">Error: ${err.message}</td></tr>`;
      });
  }

  function deleteUser(userId, username) {
    if (!confirm(`Are you sure you want to delete user "${username}" (ID: ${userId})? This action cannot be undone.`)) {
      return;
    }

    fetch(`/api/admin/users/${userId}?org_id=${getOrgId()}`, {
      method: 'DELETE',
      credentials: 'include'
    })
      .then(r => {
        if (r.ok) {
          showMessage(`User "${username}" deleted successfully.`, 'success');
          loadUsers();
        } else {
          return r.text().then(msg => showMessage('Error deleting user: ' + msg, 'error'));
        }
      })
      .catch(err => showMessage('Error deleting user: ' + err.message, 'error'));
  }

  function loadGroups() {
    const tbody = document.getElementById('groups-list');
    fetch(`/api/admin/groups?org_id=${getOrgId()}`, {
      credentials: 'include'
    })
      .then(r => r.json())
      .then(groups => {
        if (groups.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No groups found</td></tr>';
        } else {
          tbody.innerHTML = groups.map(group => `
        <tr>
          <td>${group.group_id}</td>
          <td>${group.name}</td>
          <td>${group.description || 'N/A'}</td>
          <td>${new Date(group.created_at).toLocaleDateString()}</td>
          <td>-</td>
        </tr>
      `).join('');
        }
      })
      .catch(err => {
        tbody.innerHTML = `<tr><td colspan="5" class="message message-error">Error: ${err.message}</td></tr>`;
      });
  }

  function loadOrganizations() {
    const tbody = document.getElementById('organizations-list');
    fetch('/api/admin/organizations', {
      credentials: 'include'
    })
      .then(r => r.json())
      .then(orgs => {
        if (orgs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No organizations found</td></tr>';
        } else {
          tbody.innerHTML = orgs.map(org => `
        <tr>
          <td>${org.organization_id}</td>
          <td>${org.name}</td>
          <td>${org.description || 'N/A'}</td>
          <td>
            <code id="key-${org.organization_id}">${org.secret_key}</code>
          </td>
          <td>${new Date(org.created_at).toLocaleDateString()}</td>
          <td>
            <button onclick="rotateKey(${org.organization_id}, '${org.name}')" 
                    class="btn-danger"
                    title="Generate new secret key">
              Rotate Key
            </button>
          </td>
        </tr>
      `).join('');
        }
      })
      .catch(err => {
        tbody.innerHTML = `<tr><td colspan="6" class="message message-error">Error: ${err.message}</td></tr>`;
      });
  }

  function rotateKey(orgId, orgName) {
    if (!confirm(`Are you sure you want to rotate the Secret Key for organization '${orgName}'?\nThe old key will stop working immediately.`)) {
      return;
    }

    fetch(`/api/admin/organizations/${orgId}/rotate-key`, {
      method: 'POST',
      credentials: 'include'
    })
      .then(r => r.json())
      .then(data => {
        if (data.secret_key) {
          const codeElement = document.getElementById(`key-${orgId}`);
          if (codeElement) {
            codeElement.textContent = data.secret_key;
            codeElement.style.backgroundColor = '#d4edda';
            setTimeout(() => { codeElement.style.backgroundColor = ''; }, 2000);
          }
          showMessage(`Success! New key for ${orgName}: ${data.secret_key}`, 'success');
        } else {
          showMessage('Error rotating key', 'error');
        }
      })
      .catch(err => {
        showMessage('Error rotating key: ' + err.message, 'error');
      });
  }

  document.body.addEventListener('htmx:afterSwap', function (evt) {
    if (evt.detail.target.id === 'permission-result') {
      try {
        const result = JSON.parse(evt.detail.xhr.responseText);
        const resultClass = result.has_permission ? 'message-success' : 'message-error';
        evt.detail.target.innerHTML = `
        <div class="message ${resultClass}" style="margin-top: 1rem;">
          <h4>${result.has_permission ? 'ALLOWED' : 'DENIED'}</h4>
          <p>User ID: ${result.user_id}</p>
          <p>Group: ${result.group_name}</p>
          <p>Resource: ${result.resource}</p>
          <p>Action: ${result.action}</p>
          <p><strong>Permission: ${result.has_permission ? 'Granted' : 'Denied'}</strong></p>
        </div>
      `;
      } catch (e) {
        console.error('Error parsing permission result:', e);
      }
    }
  });

  loadUsers();
</script>
{% endblock content %}